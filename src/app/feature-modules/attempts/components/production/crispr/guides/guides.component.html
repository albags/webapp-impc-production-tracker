<mat-card>
    <mat-card-subtitle>Guides</mat-card-subtitle>

    <mat-card-content>
        <div *ngIf="canUpdatePlan && crisprAttempt.nucleases[0].typeName == 'Cas9'" id="guidesSearch">
            <div id="guidesSearchForm">
                <form [formGroup]="getGuidesForm">
                    <mat-form-field appearance="fill" >
                        <input matInput placeholder="Search by gene symbol" aria-label="State" [matAutocomplete]="auto" [formControl]="searchGene" />
                        <mat-autocomplete #auto="matAutocomplete">
                            <mat-option *ngIf="isLoading" class="is-loading">Loading...</mat-option>
                            <ng-container *ngIf="!isLoading">
                                <mat-option *ngFor="let gene of filteredGenes" [value]="gene.symbol" (onSelectionChange)="selectedGene(gene)">
                                    <span><b>{{ gene.symbol }}</b> ({{ gene.accId }})</span>
                                </mat-option>
                            </ng-container>
                        </mat-autocomplete>
                    </mat-form-field>
                    <div *ngIf="error" class="error">{{ error }}</div>
                    <button mat-raised-button color="primary" (click)="findGuides();">Find guides</button>
                </form>
            </div>

            <br/>

            <div *ngIf="exons">
                <div class="wge mat-elevation-z8">
                    <table mat-table [dataSource]="exons" class="wge_info">
                        <!-- Exon Id Column -->
                        <ng-container matColumnDef="exon_id" sticky>
                        <th mat-header-cell *matHeaderCellDef> Exons </th>
                        <td mat-cell *matCellDef="let element"> {{ element.exonId }} </td>
                        </ng-container>
                    
                        <tr mat-header-row *matHeaderRowDef="displayedExonColumns sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedExonColumns; let idx=index;"
                            class="element-row" 
                            [style.background-color]="highlightedRows.indexOf(row) != -1 ? 'orange' : ''"
                            (click)="exonSelected(row, !row.rowClicked); highlight(row);"></tr>
                    </table>
                </div>

                <div *ngIf="guides" class="wge mat-elevation-z8">
                    <table mat-table [dataSource]="guides" class="wge_info">
                        <!-- Sequence Column -->
                        <ng-container matColumnDef="sequence" sticky>
                        <th mat-header-cell *matHeaderCellDef> Sequences </th>
                        <td mat-cell *matCellDef="let element"> 
                            {{ element.sequence }} 
                            <span *ngIf="element.reversed" style="font-size:8px;vertical-align:sub;">(reversed)</span>
                        </td>
                        </ng-container>
                    
                        <tr mat-header-row *matHeaderRowDef="displayedGuideColumns sticky: true"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedGuideColumns;"
                            class="element-row" 
                            [style.background-color]="row.rowClicked ? 'orange' : ''"
                            (click)="sequenceSelected(row, !row.rowClicked); row.rowClicked = !row.rowClicked;"></tr>
                    </table>
                </div>
            </div>

        </div>
    </mat-card-content>

    <br/>

    <mat-card-content>
        <div *ngIf="canUpdatePlan">
            Set individual Concentrations: <input type="checkbox"
                (change)="onSetIndividualConcentrationsClicked($event)"
                [checked]="!isConcentrationTheSameForAllGuides()">
        </div>
        
        <br/>

        <form [formGroup]="guidesForm">
            <table class="mat-elevation-z8">
                <tr>
                    <th>Sequence</th>
                    <th>Guide Sequence</th>
                    <th>PAM</th>
                    <th>Chr</th>
                    <th>Start</th>
                    <th>Stop</th>
                    <th>Strand</th>
                    <th>Genome Build</th>
                    <th>ENSEMBL exon ID</th>
                    <th>gRNA Concentration (ng/µl)</th>
                </tr>
                <ng-template ngFor let-guide let-isFirst="first" [ngForOf]="crisprAttempt.guides">
                    <tr>
                        <div *ngIf="canUpdatePlan; then editable else readOnly"></div>

                        <ng-template #editable>
                            <td>
                                <textarea class="content" matInput [(ngModel)]="guide.sequence"
                                    [ngModelOptions]="{standalone: true}"></textarea>
                            </td>
                            <td>
                                <input matInput [(ngModel)]="guide.guideSequence" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="short">
                                <input matInput [(ngModel)]="guide.pam" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="short">
                                <input matInput [(ngModel)]="guide.chr" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="medium">
                                <input matInput [(ngModel)]="guide.start" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="medium">
                                <input matInput [(ngModel)]="guide.stop" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="short">
                                <input matInput [(ngModel)]="guide.strand" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="medium">
                                <input matInput [(ngModel)]="guide.genomeBuild" [ngModelOptions]="{standalone: true}">
                            </td>
                            <td class="medium">
                                <input matInput [(ngModel)]="guide.ensemblExonId" [ngModelOptions]="{standalone: true}">
                            </td>
                        </ng-template>
                        <ng-template #readOnly>
                            <td>
                                {{ guide.sequence }}
                            </td>
                            <td>
                                {{ guide.guide_sequence }}
                            </td>
                            <td>
                                {{ guide.pam }}
                            </td>
                            <td>
                                {{ guide.chr }}
                            </td>
                            <td>
                                {{ guide.start || "Not defined" }}
                            </td>
                            <td>
                                {{ guide.end || "Not defined" }}
                            </td>
                            <td>
                                {{ guide.strand }}
                            </td>
                            <td>
                                {{ guide.genomeBuild }}
                            </td>
                            <td>
                                {{ guide.exon_id }}
                            </td>
                        </ng-template>

                        <div
                            *ngIf="sameConcentrationForAll; then sameConcentrationForAllTemplate else individualConcentrationTemplate ">
                        </div>
                        <ng-template #sameConcentrationForAllTemplate>
                            <td *ngIf="isFirst" [attr.rowspan]="this.crisprAttempt.guides.length">
                                <div *ngIf="canUpdatePlan; then concentrationEditable else concentrationReadOnly ">
                                </div>
                                <ng-template #concentrationEditable>
                                    <input type="text" formControlName="groupConcentration"
                                        (keyup)="onGroupConcentrationChanged()"> ng/µl
                                </ng-template>
                                <ng-template #concentrationReadOnly>
                                    {{ guide.grnaConcentration ? guide.grnaConcentration || 'ng/µl' : ''}}
                                </ng-template>
                            </td>
                        </ng-template>
                        <ng-template #individualConcentrationTemplate>
                            <td>
                                <div *ngIf="canUpdatePlan; then concentrationEditable else concentrationReadOnly">
                                </div>
                                <ng-template #concentrationEditable>
                                    <div [formGroup]="concentrationForm">
                                        <input (keyup)="onIndividualConcentrationChanged(guide)"
                                            [(ngModel)]="guide.grnaConcentration" [ngModelOptions]="{standalone: true}">
                                    </div>
                                </ng-template>
                                <ng-template #concentrationReadOnly>
                                    {{ guide.grnaCncentration ? guide.grnaConcentration || 'ng/µl' : ''}}
                                </ng-template>
                            </td>
                        </ng-template>

                        <td>
                            <button class="iconbutton delete-button" mat-icon-button matTooltip="Click to Delete" 
                                (click)="deleteRow(guide)">
                                <mat-icon aria-label="Delete">delete</mat-icon>
                            </button>
                        </td>
                    </tr>
                </ng-template>
                <tr>
                    <td class="no_border"><button (click)="addRow()" [disabled]="false" *ngIf="canUpdatePlan">
                            <mat-icon aria-hidden="false" aria-label="add icon">add</mat-icon>
                        </button>
                    </td>
                </tr>
            </table>
        </form>
    </mat-card-content>
</mat-card>